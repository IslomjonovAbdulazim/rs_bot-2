import asyncio
import logging
import os
import re
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()

from aiogram import Bot, Dispatcher, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.contrib.middlewares.logging import LoggingMiddleware

from aiohttp import web
import aiohttp
import gspread
from data import GOOGLE_CREDENTIALS, CREDENTIALS_FILE, SPREADSHEET_NAME, ADMINS

# ================== CONFIG ==================
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN or BOT_TOKEN == "YOUR_BOT_TOKEN":
    logging.error("âŒ BOT_TOKEN is missing or invalid! Please set it in your environment variables.")
    import sys
    sys.exit(1)

WEBHOOK_HOST = os.environ.get("RENDER_EXTERNAL_URL")
WEBHOOK_PATH = f"/webhook/{BOT_TOKEN}"
WEBHOOK_URL = f"{WEBHOOK_HOST}{WEBHOOK_PATH}"

WEBAPP_HOST = "0.0.0.0"
WEBAPP_PORT = int(os.environ.get("PORT", 5000))

logging.basicConfig(level=logging.INFO)

bot: Bot = None
dp: Dispatcher = None

# ================== STATES ==================
class Register(StatesGroup):
    name = State()
    location = State()
    phone = State()

class Broadcast(StatesGroup):
    waiting_message = State()
    confirm = State()

# ================== BUTTONS ==================
def toshkent_tumanlari():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add(
        "Yunusobod", "Chilonzor",
        "Mirzo Ulugâ€˜bek", "Yakkasaroy",
        "Shayxontohur", "Olmazor",
        "Sergeli", "Uchtepa",
        "Bektemir", "Mirobod"
    )
    return kb

def admin_panel():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("ğŸ“Š Statistika")
    kb.add("ğŸ“ Foydalanuvchilar ro'yxati", "ğŸ”™ Orqaga")
    return kb

# ================== ADMIN HANDLERS ==================
async def admin_command(message: types.Message):
    if message.from_user.id not in ADMINS:
        await message.reply("âŒ Sizda admin huquqi yo'q!")
        return
    
    await message.reply(
        "ğŸ‘¨â€ğŸ’¼ <b>Admin Panel</b>\n\nKerakli bo'limni tanlang:",
        parse_mode="HTML",
        reply_markup=admin_panel()
    )

async def admin_menu_handler(message: types.Message, state: FSMContext):
    if message.from_user.id not in ADMINS:
        return
    
    if message.text == "ğŸ“Š Statistika":
        try:
            stats = get_statistics()
            await message.reply(
                f"ğŸ“Š <b>Bot Statistikasi</b>\n\n"
                f"ğŸ‘¥ Jami foydalanuvchilar: {stats['total_users']}\n"
                f"ğŸ“… Bugungi ro'yxatlar: {stats['today_registrations']}\n"
                f"ğŸ“† Haftalik ro'yxatlar: {stats['week_registrations']}",
                parse_mode="HTML"
            )
        except Exception as e:
            logging.error(f"Statistics error: {e}")
            await message.reply("âŒ Statistikani olishda xatolik yuz berdi")
    
    elif message.text == "ğŸ“ Foydalanuvchilar ro'yxati":
        try:
            users = get_all_users()
            if users:
                unknown = "Noma'lum"
                user_list = "\n".join([
                    f"{i+1}. {u.get('Ism', unknown)} - {u.get('Telefon', unknown)} ({u.get('Tuman', unknown)})" 
                    for i, u in enumerate(users[:20])
                ])
                await message.reply(
                    f"ğŸ‘¥ <b>Oxirgi 20 ta foydalanuvchi:</b>\n\n{user_list}\n\nğŸ“„ Google Sheets: https://docs.google.com/spreadsheets/d/1uyEIDxGqE8QtJNQZLjCvTch_iaelbg8QwT5XhuhbzcY",
                    parse_mode="HTML"
                )
            else:
                await message.reply("ğŸ“­ Hozircha foydalanuvchilar yo'q")
        except Exception as e:
            logging.error(f"Users list error: {e}")
            await message.reply("âŒ Ro'yxatni olishda xatolik yuz berdi")
    
    elif message.text == "ğŸ”™ Orqaga":
        await state.finish()
        await message.reply("Bosh menyu", reply_markup=types.ReplyKeyboardRemove())

async def broadcast_confirm_handler(message: types.Message, state: FSMContext):
    if message.text == "âœ… Ha, yuborish":
        data = await state.get_data()
        broadcast_msg = data.get('broadcast_message')
        
        try:
            users = get_all_users()
            sent = 0
            failed = 0
            
            await message.reply("ğŸ“¤ Xabar yuborilmoqda...", reply_markup=types.ReplyKeyboardRemove())
            
            for user in users:
                try:
                    user_id = user.get('User ID')
                    if user_id:
                        await broadcast_msg.copy_to(user_id)
                        sent += 1
                        await asyncio.sleep(0.05)  # Spam oldini olish
                except Exception as e:
                    failed += 1
                    logging.error(f"Broadcast error for user {user.get('User ID')}: {e}")
            
            await message.reply(
                f"âœ… <b>Xabar yuborish yakunlandi!</b>\n\n"
                f"ğŸ“Š Muvaffaqiyatli: {sent}\n"
                f"âŒ Xatolik: {failed}",
                parse_mode="HTML",
                reply_markup=admin_panel()
            )
        except Exception as e:
            logging.error(f"Broadcast error: {e}")
            await message.reply("âŒ Xabar yuborishda xatolik yuz berdi", reply_markup=admin_panel())
    else:
        await message.reply("âŒ Xabar yuborish bekor qilindi", reply_markup=admin_panel())
    
    await state.finish()

# ================== USER HANDLERS ==================
async def start_handler(message: types.Message, state: FSMContext):
    await state.finish()
    
    # Admin uchun admin panel
    if message.from_user.id in ADMINS:
        await message.reply(
            f"Assalomu Alaykum! ğŸ˜Š</b>\n\n"
            "Siz admin sifatida kirdingiz. /admin buyrug'ini ishlating.",
            parse_mode="HTML"
        )
        return
    
    await message.reply(
        f"Assalomu Alaykum, <b>{message.from_user.full_name} ğŸ˜Š</b>\n\n"
        "Autizm haqidagi qo'llanmani olish uchun 3 qadam qoldi ğŸ¤© \n\n1-qadam: \n"
        "ğŸ“ Ismingizni kiriting:",
        parse_mode="HTML"
    )
    await Register.name.set()

async def process_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await Register.location.set()

    await message.reply(
        "ğŸ“Toshkent shahrining qaysi tumanida yashaysiz?",
        reply_markup=toshkent_tumanlari()
    )

async def process_location(message: types.Message, state: FSMContext):
    location = message.text
    await state.update_data(location=location)
    await Register.phone.set()
    
    contact_button = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    contact_button.add(types.KeyboardButton("ğŸ“± Telefon raqamini yuborish", request_contact=True))
    contact_button.add(types.KeyboardButton("âœï¸  Raqamni qo'lda kiritish"))
    
    await message.reply(
        "2-qadam: \n\n Telefon raqamingizni kiriting:\n\n"
        "ğŸ“± Telefon raqamini yuborish tugmasini bosing yoki\n"
        "Namuna: 901234567",
        reply_markup=contact_button
    )

async def process_phone(message: types.Message, state: FSMContext):
    phone = ""
    if message.contact:
        phone = message.contact.phone_number
    else:
        phone = message.text
        if phone == "âœï¸  Raqamni qo'lda kiritish":
            await message.reply(
                "Telefon raqamingizni kiriting:\nNamuna: 901234567",
                reply_markup=types.ReplyKeyboardRemove()
            )
            return
        phone_digits = re.sub(r'\D', '', phone)
        if len(phone_digits) == 9:
            phone = f"+998{phone_digits}"
        elif len(phone_digits) == 12 and phone_digits.startswith('998'):
            phone = f"+{phone_digits}"
        elif len(phone_digits) == 13 and phone.startswith('+'):
            phone = f"+{phone_digits}"
        elif len(phone_digits) == 10 and phone_digits.startswith('8'):
            phone = f"+7{phone_digits[1:]}"
        else:
            await message.reply(
                "âŒ Noto'g'ri telefon raqami formati!\n"
                "âœ… Qabul qilinadigan formatlar:\n"
                "â€¢ 901234567\n"
                "â€¢ +998901234567\n"
                "â€¢ 998901234567"
            )
            return
    
    data = await state.get_data()
    user_name = data.get('name')
    location = data.get('location')

    save_to_sheets({
        "Ism": user_name,
        "Tuman": location,
        "Telefon": phone,
        "User ID": message.from_user.id,
        "To'liq ism": message.from_user.full_name,
        "Vaqt": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    })

    # Adminga habar
    admin_message = (
        f"ğŸ¯ <b>Yangi ro'yxatdan o'tish:</b>\n\n"
        f"ğŸ‘¤ <b>Ism:</b> {user_name}\n"
        f"ğŸ“ <b>Tuman:</b> {location}\n"
        f"ğŸ“± <b>Telefon:</b> {phone}\n"
        f"ğŸ†” <b>User ID:</b> {message.from_user.id}\n"
        f"ğŸ“› <b>To'liq ism:</b> {message.from_user.full_name}\n"
        f"ğŸ“… <b>Vaqt:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"
        f"#yangi_royhat"
    )
    
    for admin_id in ADMINS:
        try:
            await bot.send_message(admin_id, admin_message, parse_mode="HTML")
        except Exception as e:
            logging.error(f"Error sending message to admin {admin_id}: {e}")

    await state.finish()

    # 1. Avval faylni yuborish
    try:
        with open("Autizm.pdf", "rb") as file:
            await message.reply_document(
                file,
                reply_markup=types.ReplyKeyboardRemove()
            )
    except Exception as e:
        logging.error(f"Error sending PDF: {e}")
        await message.answer("Kechirasiz, qo'llanmani yuborishda xatolik yuz berdi admin bilan bog'laning.")
        return
    
    # 2. Keyin xabarni yuborish
    await message.answer(
        "ğŸ‰ Siz muvaffaqiyatli ro'yxatdan o'tdingiz!\n\n"
        "ğŸ“š Marhamat, autizm haqidagi maxsus qo'llanma\n\n"
        "ğŸ”” Bizni ijtimoiy tarmoqlarda kuzatib boring:\n\n"
        "<a href='https://t.me/rahimovkids'>Telegram</a> | "
        "<a href='https://instagram.com/rahimovkids'>Instagram</a> | "
        "<a href='https://youtube.com/@RahimovKids'>YouTube</a> | "
        "<a href='https://www.rahimovkids.uz/'>Veb-sayt</a>",
        parse_mode="HTML",
        disable_web_page_preview=True
    )

# ================== GOOGLE SHEETS ==================
def save_to_sheets(row_data: dict):
    try:
        if GOOGLE_CREDENTIALS:
            gc = gspread.service_account_from_dict(GOOGLE_CREDENTIALS)
        else:
            gc = gspread.service_account(filename=CREDENTIALS_FILE)
        
        sh = gc.open(SPREADSHEET_NAME)
        wks = sh.get_worksheet(0)
        
        # Headerlarni tekshirish va qo'shish (agar bo'sh bo'lsa)
        headers = wks.row_values(1)
        if not headers:
            wks.insert_row(list(row_data.keys()), 1)
            headers = list(row_data.keys())
        
        # Ma'lumotni tartib bilan qo'shish
        row = [row_data.get(h, "") for h in headers]
        wks.append_row(row)
        logging.info("ğŸ“ Ma'lumot Google Sheetsga saqlandi!")
    except Exception as e:
        logging.error(f"âŒ Google Sheets xatosi: {e}")

def get_statistics():
    try:
        if GOOGLE_CREDENTIALS:
            gc = gspread.service_account_from_dict(GOOGLE_CREDENTIALS)
        else:
            gc = gspread.service_account(filename=CREDENTIALS_FILE)
        
        sh = gc.open(SPREADSHEET_NAME)
        wks = sh.get_worksheet(0)
        
        all_records = wks.get_all_records()
        total_users = len(all_records)
        
        today = datetime.now().strftime("%Y-%m-%d")
        today_registrations = sum(1 for r in all_records if r.get('Vaqt', '').startswith(today))
        
        # Haftalik hisobi uchun 7 kun oldinga
        from datetime import timedelta
        week_ago = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
        week_registrations = sum(1 for r in all_records if r.get('Vaqt', '') >= week_ago)
        
        return {
            'total_users': total_users,
            'today_registrations': today_registrations,
            'week_registrations': week_registrations
        }
    except Exception as e:
        logging.error(f"Statistics error: {e}")
        return {'total_users': 0, 'today_registrations': 0, 'week_registrations': 0}

def get_all_users():
    try:
        if GOOGLE_CREDENTIALS:
            gc = gspread.service_account_from_dict(GOOGLE_CREDENTIALS)
        else:
            gc = gspread.service_account(filename=CREDENTIALS_FILE)
        
        sh = gc.open(SPREADSHEET_NAME)
        wks = sh.get_worksheet(0)
        
        return wks.get_all_records()
    except Exception as e:
        logging.error(f"Get users error: {e}")
        return []

# ================== WEBHOOK ==================
async def handle_webhook(request):
    data = await request.json()
    update = types.Update(**data)
    await dp.feed_update(bot, update)
    return web.Response(text="OK")

# ================== HEALTH CHECK ==================
async def health(request):
    return web.Response(text="OK")

# ================== SELF PING (NO MESSAGE) ==================
async def self_ping():
    await asyncio.sleep(30)  # bot to'liq ishga tushsin
    while True:
        try:
            async with aiohttp.ClientSession() as session:
                await session.get(WEBHOOK_HOST)
                logging.info("ğŸ” Self ping OK")
        except Exception as e:
            logging.error(f"PING ERROR: {e}")

        await asyncio.sleep(600)  # 10 minut

# ================== MAIN ==================
async def main():
    global bot, dp

    bot = Bot(BOT_TOKEN)
    dp = Dispatcher(bot, storage=MemoryStorage())

    # ğŸ”¥ WEBHOOK SOZLAMALARI
    if not WEBHOOK_HOST or "render.com" not in WEBHOOK_HOST and "http" not in WEBHOOK_HOST:
        logging.warning("âš ï¸ WEBHOOK_HOST topilmadi yoki noto'g'ri. Polling rejimiga o'tilmoqda...")
        USE_WEBHOOK = False
    else:
        USE_WEBHOOK = True

    dp.middleware.setup(LoggingMiddleware())

    # Admin handlers
    dp.register_message_handler(admin_command, commands=["admin"])
    dp.register_message_handler(broadcast_confirm_handler, state=Broadcast.confirm)
    
    dp.register_message_handler(admin_menu_handler, lambda msg: msg.text in ["ğŸ“Š Statistika", "ğŸ“ Foydalanuvchilar ro'yxati", "ğŸ”™ Orqaga"])
    
    # User handlers
    dp.register_message_handler(start_handler, commands=["start"])
    dp.register_message_handler(process_name, state=Register.name)
    dp.register_message_handler(process_location, state=Register.location)
    dp.register_message_handler(
        process_phone,
        state=Register.phone,
        content_types=["text", "contact"]
    )

    if USE_WEBHOOK:
        try:
            await bot.set_webhook(WEBHOOK_URL)
            logging.info(f"âœ… Webhook o'rnatildi: {WEBHOOK_URL}")
            
            app = web.Application()
            app.router.add_get("/", health)
            app.router.add_post(WEBHOOK_PATH, handle_webhook)

            runner = web.AppRunner(app)
            await runner.setup()
            site = web.TCPSite(runner, WEBAPP_HOST, WEBAPP_PORT)
            await site.start()

            # ğŸ” SELF PING ISHGA TUSHADI
            asyncio.create_task(self_ping())
            logging.info("ğŸš€ Bot ishga tushdi (Webhook rejimida)")
            await asyncio.Event().wait()
        except Exception as e:
            logging.error(f"âŒ Webhook xatosi: {e}")
            logging.warning("âš ï¸ Polling rejimiga o'tilmoqda...")
            USE_WEBHOOK = False

    if not USE_WEBHOOK:
        logging.info("ğŸš€ Bot ishga tushdi (Polling rejimida)")
        await dp.start_polling()

if __name__ == "__main__":
    asyncio.run(main())
